# API-based Extension

Developers can extend module capabilities through the API extension module. Currently supported module extensions include:

* `moderation`&#x20;
* `external_data_tool`&#x20;

Before extending module capabilities, you need to prepare an API and an API Key for authentication (which can also be automatically generated by Dify, optional). In addition to developing the corresponding module capabilities, you also need to follow the specifications below so that Dify can invoke the API correctly.\


### API Specifications

Dify will invoke your API according to the following specifications:

#### Header

| Header          | Value             | Desc                                                                                                                                         |
| --------------- | ----------------- | -------------------------------------------------------------------------------------------------------------------------------------------- |
| `Content-Type`  | application/json  | The request content is in JSON format.                                                                                                       |
| `Authorization` | Bearer {api\_key} | The API Key is transmitted as a token. You need to parse the `api_key` and verify if it matches the provided API Key to ensure API security. |

#### Request Body

```JSON
{
    "point":  string, 
    "params": {
        ...  
    }
}
```

#### API Response

```JSON
{
    ...  
}

```

### Check

When configuring API-based Extension in Dify, Dify will send a request to the API Endpoint to verify the availability of the API. When the API Endpoint receives `point=ping`, the API should return `result=pong`, as follows:

#### Header

```JSON
Content-Type: application/json
Authorization: Bearer {api_key}
```

#### Request Body

```JSON
{
    "point": "ping"
}
```

#### Expected API response

```JSON
{
    "result": "pong"
}
```

\


### For Example

Here we take the external data tool as an example, where the scenario is to retrieve external weather information based on the region as context.

#### API Specifications

`POST https://fake-domain.com/api/dify/receive`

**Header**

```JSON
Content-Type: application/json
Authorization: Bearer 123456
```

**Request Body**

```JSON
{
    "point": "app.external_data_tool.query",
    "params": {
        "app_id": "61248ab4-1125-45be-ae32-0ce91334d021",
        "tool_variable": "weather_retrieve",
        "inputs": {
            "location": "London"
        },
        "query": "How's the weather today?"
    }
}
```

**API Response**

```JSON
{
    "result": "City: London\nTemperature: 10°C\nRealFeel®: 8°C\nAir Quality: Poor\nWind Direction: ENE\nWind Speed: 8 km/h\nWind Gusts: 14 km/h\nPrecipitation: Light rain"
}
```

#### Code demo

1. ```Bash
   pip install 'fastapi[all]' uvicorn
   ```
2. ```Python
   from fastapi import FastAPI, Body, HTTPException, Header
   from pydantic import BaseModel

   app = FastAPI()


   class InputData(BaseModel):
       point: str
       params: dict


   @app.post("/api/dify/receive")
   async def dify_receive(data: InputData = Body(...), authorization: str = Header(None)):
       """
       Receive API query data from Dify.
       """
       expected_api_key = "123456"  # TODO Your API key of this API
       auth_scheme, _, api_key = authorization.partition(' ')

       if auth_scheme.lower() != "bearer" or api_key != expected_api_key:
           raise HTTPException(status_code=401, detail="Unauthorized")

       point = data.point

       # for debug
       print(f"point: {point}")

       if point == "ping":
           return {
               "result": "pong"
           }
       if point == "app.external_data_tool.query":
           return handle_app_external_data_tool_query(params=data.params)
       # elif point == "{point name}":
           # TODO other point implementation here

       raise HTTPException(status_code=400, detail="Not implemented")


   def handle_app_external_data_tool_query(params: dict):
       app_id = params.get("app_id")
       tool_variable = params.get("tool_variable")
       inputs = params.get("inputs")
       query = params.get("query")

       # for debug
       print(f"app_id: {app_id}")
       print(f"tool_variable: {tool_variable}")
       print(f"inputs: {inputs}")
       print(f"query: {query}")

       # TODO your external data tool query implementation here, 
       #  return must be a dict with key "result", and the value is the query result
       if inputs.get("location") == "London":
           return {
               "result": "City: London\nTemperature: 10°C\nRealFeel®: 8°C\nAir Quality: Poor\nWind Direction: ENE\nWind "
                         "Speed: 8 km/h\nWind Gusts: 14 km/h\nPrecipitation: Light rain"
           }
       else:
           return {"result": "Unknown city"}
   ```

When debugging the App, Dify will request the configured API and send the following content (example):

```JSON
{
    "point": "app.external_data_tool.query",
    "params": {
        "app_id": "61248ab4-1125-45be-ae32-0ce91334d021",
        "tool_variable": "weather_retrieve",
        "inputs": {
            "location": "London"
        },
        "query": "How's the weather today?"
    }
}
```

API Response：

```JSON
{
    "result": "City: London\nTemperature: 10°C\nRealFeel®: 8°C\nAir Quality: Poor\nWind Direction: ENE\nWind Speed: 8 km/h\nWind Gusts: 14 km/h\nPrecipitation: Light rain"
}
```

\
